= Virtualization Guide

== Introduction

This guide describes how to generate a virtual machine (VM) or container image that provides 
a complete TEAM Engine installation along with the latest OGC conformance test suites. The 
required software components are shown in the following figure.

.Software components 
image::./images/teamengine-vm.png[software components]

https://www.packer.io/[Packer] is an open-source infrastructure definition tool used 
to create images for a variety of dynamic infrastructure platforms. It includes builders 
for many virtual environments, such as:

* VirtualBox
* Amazon EC2
* VMware vSphere
* Google Compute Engine
* Docker (container)

.Virtual machines vs. containers
**********
A container is not a full-blown virtual machine--it doesn't require a hypervisor and runs in 
an isolated environment provided by a single host operating system. Since the OS kernel is 
shared, a container generally has less overhead than a virtual machine. Container technologies 
such as Docker, Warden, and Rocket offer a way to package and distribute a service or an 
application along with its dependencies.
**********

The build process is driven by a template: a configuration file (in JSON format) that defines 
how a machine image is created and automatically provisioned.

To install Packer, simply download the appropriate https://www.packer.io/downloads.html[binary package] 
for your environment and unpack the archive in a suitable directory; then set the following user 
environment variables:

PACKER_HOME:: The directory where packer is installed.
PACKER_CACHE_DIR:: The location of the packer cache (for downloaded resources).

Update the PATH environment variable to include PACKER_HOME.


== VirtualBox

=== Overview

https://www.virtualbox.org/[VirtualBox] is a freely available virtualization product 
that runs on Windows, Linux, and Mac hosts. It supports a wide variety of guest operating 
systems and is very useful in creating development or test environments. The Packer 
template will create a complete, ready-to-run TEAM Engine installation that contains
the desired set of OGC test suites. The output is a "virtual appliance" (in the 
standard http://www.dmtf.org/standards/ovf[OVF format]) that can be imported into VirtualBox.

=== Install VirtualBox

To install VirtualBox, download a suitable https://www.virtualbox.org/wiki/Downloads[installation package] for 
your host environment; see the user manual for https://www.virtualbox.org/manual/ch02.html[installation instructions].
When installation is complete, set the following user environment variable:

VBOX_USER_HOME:: The location where virtual machines will be created.

=== Create and import the image

The Packer template makes use of several supporting shell scripts and files (see Note 1). In the 
'files' subdirectory is a CSV file (ets-releases.csv) that contains a list of OGC test suite releases; 
each line has two fields: a Git repository URL, and a tag name indicating the release version. The 
test suites listed in this file will be added to the TEAM-engine instance. If a test suite is not 
wanted, just comment it out by inserting a number sign (or hash character, #) at the beginning of 
the appropriate line.

[icons=None, caption="Note 1"]
[NOTE]
==========
The template file (teamengine-virtualbox.json) can be found in the src/main/config/packer/ directory in the 
TEAM Engine source tree, or wherever the Packer assembly was unpacked. To create the packer assembly, run 
this Maven command at the root of the TEAM Engine source tree: `mvn assembly:single`.
==========

The template defines several user variables that can be overridden from the command line or a file; 
see https://www.packer.io/docs/templates/user-variables.html). These are listed in the table below, 
along with their default values.

.Template variables
[cols="1,1,3"]
|==========
|Variable |Default value |Description 

|te_version |"4.9" |The desired version of the TEAM Engine web application http://search.maven.org/#search%7Cga%7C1%7Ca%3A%22teamengine-web%22[available at Maven Central].
|ets_resources_release |"" |The desired https://github.com/opengeospatial/ets-resources/releases[ets-resources release version];
this project aggregates all test suite dependencies. If not specified, the latest snapshot (tip of the master branch) will be used.
|use_oracle_jdk |"false" |Whether or not to use the Oracle JDK (which is subject to a 
http://www.oracle.com/technetwork/java/javase/terms/license/index.html[license agreement]). 
If not, OpenJDK will be used.
|==========

To create the virtual appliance, simply change to the directory containing the Packer template and 
execute this command in a shell console:

-----
packer build teamengine-virtualbox.json
-----

The appliance will be created in the output-centos72-virtualbox subdirectory. The base operating 
system is https://www.centos.org/[CentOS] 7.2 (more specifically, the minimal distribution intended 
for "headless" operation). To run it, start VirtualBox and perform the following steps:

. Choose *File > Import Appliance...* and select the *.ovf file 
. When the import is completed, select the newly created virtual machine and press "Start" 
. When the boot sequence finishes, login using an SSH client to localhost:2222--or use the 
VirtualBox terminal--with the TEAM Engine user credentials (see Note 2) 
. To start or stop Tomcat, execute this command:  `sudo systemctl start|stop tomcat-jsvc`
. The main TEAM Engine web app is available at \http://localhost:8888/teamengine (see Note 3) 


[icons=None, caption="Note 2"]
[NOTE]
==========
The user credentials are specified in the Packer template (`ssh_name`, `ssh_pass`). This is a 
normal user account with 'sudo' privileges.
==========

[icons=None, caption="Note 3"]
[NOTE]
==========
The VM runs on a private internal network using the default networking mode: network address 
translation (NAT); this prevents all direct inbound connections, but not outbound connections. 
Some port forwarding rules are created in order to allow remote access to the SSH server (via 
localhost:2222) and the Tomcat web container (via localhost:8888).
==========


== Amazon EC2

=== Overview
Amazon Web Services (AWS) is a diverse platform of services that offer computing, storage, and 
networking capabilities in a public cloud environment. Amazon Elastic Compute Cloud (EC2) is a 
constituent service that provides dynamic infrastructure as a service (IaaS). Virtual servers 
can be created, launched, configured, and managed as needed.

=== Preparation
Before building an image, an Amazon Web Services (AWS) account must be available to use. If not, 
https://portal.aws.amazon.com/gp/aws/developer/registration/[sign up for an AWS account]. The Packer 
template complies with the restrictions of the https://aws.amazon.com/free/[free tier] so you will 
not be charged unless your usage exceeds the stipulated limits. It is strongly recommended to *not* 
use the root account (that is, the account owner). Instead, create a separate AWS Identity 
and Access Management (IAM) user to interact with AWS. For guidance about how to do this, see 
http://docs.aws.amazon.com/IAM/latest/UserGuide/getting-started_create-admin-group.html[Creating Your First IAM Admin User and Group].

[icons=None, caption="Note 4"]
[NOTE]
==========
The AWS Free Tier offerings are available to new AWS customers for 12 months following the sign-up 
date. It allows up to 750 hours usage per month of a moderately small instance (instance type "t2.micro": 
1 vCPU, 1 GiB memory). Note that the monthly allotment for Linux and Microsoft Windows instances is counted 
separately. Usage that exceeds the free tier limits is subject to billing. For more information, see 
http://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/billing-free-tier.html[Using the Free Tier].
==========

You will need the security credentials for the IAM user; specifically, the https://aws.amazon.com/developers/access-keys/[access keys] 
required to send requests using various AWS APIs. Set them as the values of the environment variables 
shown below (which are also supported by the AWS command-line interface). The Packer template will 
obtain the credentials from these environment variables:

AWS_ACCESS_KEY_ID:: Access Key ID
AWS_SECRET_ACCESS_KEY:: Secret Access Key

The source image is the official https://wiki.centos.org/Cloud/AWS[CentOS 7 HVM image], which is 
freely available from the AWS Marketplace. However, a subscription is required in order to access it. 
Visit the http://aws.amazon.com/marketplace/pp?sku=aw0evgkw8e5c1q413zgy5pjce[AWS Marketplace page] 
for the official CentOS 7 image. Click "Continue" and select the "Manual Launch" tab. Then click 
"Accept Software Terms" in order to subscribe and enable access in any supported region.

=== Create and register the image

The same template variables as defined for the VirtualBox image apply here. To create and register 
the image, change to the directory containing the Packer template and execute this command in a shell 
console:

-----
packer build teamengine-aws.json
-----

When the process is completed, the image will appear in the AWS EC2 console--under IMAGES/AMIs--for 
the "N. Virginia" region (us-east-1). Note that the image will be marked as private, so it can 
only be launched by the owning account. If you have installed and configured the 
http://docs.aws.amazon.com/cli/latest/userguide/[AWS command-line tools], run the `describe-images` 
command:

-----
aws ec2 describe-images --owners self --region us-east-1
-----

An instance can be launched from the EC2 dashboard by selecting the image and clicking "Launch".
Access via SSH is permitted from anywhere by default, but the source IP address can be restricted 
to a single address or an address range (in CIDR notation: 192.168.0.0/16). When the instance 
reaches the "running" state it will appear in the console under INSTANCES/Instances. The public 
hostname and IP address will be displayed on the "Description" tab. Connect via SSH and login 
as 'centos' using the key specified at launch. The server may be stopped and started as needed 
by selecting the appropriate action on the `Actions > Instance State` submenu.
